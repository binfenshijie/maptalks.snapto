/*!
 * maptalks.snapto v0.1.11
 * LICENSE : MIT
 * (c) 2016-2018 maptalks.org
 */
/*!
 * requires maptalks@^0.33.1 
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("maptalks")):"function"==typeof define&&define.amd?define(["exports","maptalks"],e):e(t.maptalks=t.maptalks||{},t.maptalks)}(this,function(t,e){"use strict";function o(t,e){if(!(this instanceof o))return new o(t,e);this._maxEntries=Math.max(4,t||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),e&&this._initFormat(e),this.clear()}function n(t,e,o){if(!o)return e.indexOf(t);for(var n=0;n<e.length;n++)if(o(t,e[n]))return n;return-1}function r(t,e){i(t,0,t.children.length,e,t)}function i(t,e,o,n,r){r||(r=d(null)),r.minX=1/0,r.minY=1/0,r.maxX=-1/0,r.maxY=-1/0;for(var i,s=e;s<o;s++)i=t.children[s],a(r,t.leaf?n(i):i);return r}function a(t,e){return t.minX=Math.min(t.minX,e.minX),t.minY=Math.min(t.minY,e.minY),t.maxX=Math.max(t.maxX,e.maxX),t.maxY=Math.max(t.maxY,e.maxY),t}function s(t,e){return t.minX-e.minX}function c(t,e){return t.minY-e.minY}function h(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function u(t){return t.maxX-t.minX+(t.maxY-t.minY)}function l(t,e){return(Math.max(e.maxX,t.maxX)-Math.min(e.minX,t.minX))*(Math.max(e.maxY,t.maxY)-Math.min(e.minY,t.minY))}function f(t,e){var o=Math.max(t.minX,e.minX),n=Math.max(t.minY,e.minY),r=Math.min(t.maxX,e.maxX),i=Math.min(t.maxY,e.maxY);return Math.max(0,r-o)*Math.max(0,i-n)}function p(t,e){return t.minX<=e.minX&&t.minY<=e.minY&&e.maxX<=t.maxX&&e.maxY<=t.maxY}function m(t,e){return e.minX<=t.maxX&&e.minY<=t.maxY&&e.maxX>=t.minX&&e.maxY>=t.minY}function d(t){return{children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function y(t,e,o,n,r){for(var i,a=[e,o];a.length;)o=a.pop(),e=a.pop(),o-e<=n||(i=e+Math.ceil((o-e)/n/2)*n,J(t,i,e,o,r),a.push(e,i,i,o))}function g(t,e,o){if(null!==t){var n,r,i,a,s,c,h,u,l,f,p=0,m=0,d=t.type,y="FeatureCollection"===d,v="Feature"===d,_=y?t.features.length:1;for(n=0;n<_;n++)for(l=y?t.features[n].geometry:v?t.geometry:t,f=!!l&&"GeometryCollection"===l.type,h=f?l.geometries.length:1,r=0;r<h;r++){var x=0;if(null!==(c=f?l.geometries[r]:l)){u=c.coordinates;var P=c.type;switch(p=!o||"Polygon"!==P&&"MultiPolygon"!==P?0:1,P){case null:break;case"Point":e(u,m,n,x),m++,x++;break;case"LineString":case"MultiPoint":for(i=0;i<u.length;i++)e(u[i],m,n,x),m++,"MultiPoint"===P&&x++;"LineString"===P&&x++;break;case"Polygon":case"MultiLineString":for(i=0;i<u.length;i++){for(a=0;a<u[i].length-p;a++)e(u[i][a],m,n,x),m++;"MultiLineString"===P&&x++}"Polygon"===P&&x++;break;case"MultiPolygon":for(i=0;i<u.length;i++){for(a=0;a<u[i].length;a++)for(s=0;s<u[i][a].length-p;s++)e(u[i][a][s],m,n,x),m++;x++}break;case"GeometryCollection":for(i=0;i<c.geometries.length;i++)g(c.geometries[i],e,o);break;default:throw new Error("Unknown Geometry Type")}}}}}function v(t,e,o,n){var r=o;return g(t,function(t,n,i,a){r=0===n&&void 0===o?t:e(r,t,n,i,a)},n),r}function _(t,e){var o;switch(t.type){case"FeatureCollection":for(o=0;o<t.features.length;o++)e(t.features[o].properties,o);break;case"Feature":e(t.properties,0)}}function x(t,e,o){var n=o;return _(t,function(t,r){n=0===r&&void 0===o?t:e(n,t,r)}),n}function P(t,e){if("Feature"===t.type)e(t,0);else if("FeatureCollection"===t.type)for(var o=0;o<t.features.length;o++)e(t.features[o],o)}function M(t,e,o){var n=o;return P(t,function(t,r){n=0===r&&void 0===o?t:e(n,t,r)}),n}function b(t){var e=[];return g(t,function(t){e.push(t)}),e}function w(t,e){var o,n,r,i,a,s,c,h,u=0,l="FeatureCollection"===t.type,f="Feature"===t.type,p=l?t.features.length:1;for(o=0;o<p;o++){for(s=l?t.features[o].geometry:f?t.geometry:t,h=l?t.features[o].properties:f?t.properties:{},c=!!s&&"GeometryCollection"===s.type,a=c?s.geometries.length:1,r=0;r<a;r++)if(null!==(i=c?s.geometries[r]:s))switch(i.type){case"Point":case"LineString":case"MultiPoint":case"Polygon":case"MultiLineString":case"MultiPolygon":e(i,u,h);break;case"GeometryCollection":for(n=0;n<i.geometries.length;n++)e(i.geometries[n],u,h);break;default:throw new Error("Unknown Geometry Type")}else e(null,u,h);u++}}function C(t,e,o){var n=o;return w(t,function(t,r,i){n=0===r&&void 0===o?t:e(n,t,r,i)}),n}function E(t,e){w(t,function(t,o,n){var r=null===t?null:t.type;switch(r){case null:case"Point":case"LineString":case"Polygon":return void e(L(t,n),o,0)}var i;switch(r){case"MultiPoint":i="Point";break;case"MultiLineString":i="LineString";break;case"MultiPolygon":i="Polygon"}t.coordinates.forEach(function(t,r){e(L({type:i,coordinates:t},n),o,r)})})}function G(t,e,o){var n=o;return E(t,function(t,r,i){n=0===r&&0===i&&void 0===o?t:e(n,t,r,i)}),n}function k(t,e){E(t,function(t,o,n){var r=0;if(t.geometry){var i=t.geometry.type;"Point"!==i&&"MultiPoint"!==i&&v(t,function(i,a){var s=X([i,a],t.properties);return e(s,o,n,r),r++,a})}})}function B(t,e,o){var n=o,r=!1;return k(t,function(t,i,a,s){n=!1===r&&void 0===o?t:e(n,t,i,a,s),r=!0}),n}function L(t,e){if(void 0===t)throw new Error("No geometry passed");return{type:"Feature",properties:e||{},geometry:t}}function X(t,e){if(!t)throw new Error("No coordinates passed");if(t.length<2)throw new Error("Coordinates must be an array of two or more positions");return{type:"Feature",properties:e||{},geometry:{type:"LineString",coordinates:t}}}function Y(t,e){if(!t)throw new Error("geojson is required");var o=t.geometry?t.geometry.type:t.type;if(!o)throw new Error("invalid geojson");if("FeatureCollection"===o)throw new Error("FeatureCollection is not supported");if("GeometryCollection"===o)throw new Error("GeometryCollection is not supported");var n=t.geometry?t.geometry.coordinates:t.coordinates;if(!n)throw new Error("geojson must contain coordinates");switch(o){case"LineString":return void e(n,0,0);case"Polygon":case"MultiLineString":for(var r=0,i=0;i<n.length;i++)"MultiLineString"===o&&(r=i),e(n[i],i,r);return;case"MultiPolygon":for(var a=0;a<n.length;a++)for(var s=0;s<n[a].length;s++)e(n[a][s],s,a);return;default:throw new Error(o+" geometry not supported")}}function S(t,e,o){var n=o;return Y(t,function(t,r,i){n=0===r&&void 0===o?t:e(n,t,r,i)}),n}function T(t){var e=[t[0],t[1]],o=[t[0],t[3]],n=[t[2],t[3]];return{type:"Feature",bbox:t,properties:{},geometry:{type:"Polygon",coordinates:[[e,[t[2],t[1]],n,o,e]]}}}function O(t){var e=[1/0,1/0,-1/0,-1/0];return z(t,function(t){e[0]>t[0]&&(e[0]=t[0]),e[1]>t[1]&&(e[1]=t[1]),e[2]<t[0]&&(e[2]=t[0]),e[3]<t[1]&&(e[3]=t[1])}),e}function F(t,e){for(var o=Object.getOwnPropertyNames(e),n=0;n<o.length;n++){var r=o[n],i=Object.getOwnPropertyDescriptor(e,r);i&&i.configurable&&void 0===t[r]&&Object.defineProperty(t,r,i)}return t}function A(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function j(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function R(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):F(t,e))}var N=("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self,function(t,e){return e={exports:{}},t(e,e.exports),e.exports}(function(t,e){!function(e,o){t.exports=function(){function t(t,o,r,i,a){e(t,o,r||0,i||t.length-1,a||n)}function e(t,n,r,i,a){for(;i>r;){if(i-r>600){var s=i-r+1,c=n-r+1,h=Math.log(s),u=.5*Math.exp(2*h/3),l=.5*Math.sqrt(h*u*(s-u)/s)*(c-s/2<0?-1:1);e(t,n,Math.max(r,Math.floor(n-c*u/s+l)),Math.min(i,Math.floor(n+(s-c)*u/s+l)),a)}var f=t[n],p=r,m=i;for(o(t,r,n),a(t[i],f)>0&&o(t,r,i);p<m;){for(o(t,p,m),p++,m--;a(t[p],f)<0;)p++;for(;a(t[m],f)>0;)m--}0===a(t[r],f)?o(t,r,m):(m++,o(t,m,i)),m<=n&&(r=m+1),n<=m&&(i=m-1)}}function o(t,e,o){var n=t[e];t[e]=t[o],t[o]=n}function n(t,e){return t<e?-1:t>e?1:0}return t}()}()})),q=o,D=o,J=N;o.prototype={all:function(){return this._all(this.data,[])},search:function(t){var e=this.data,o=[],n=this.toBBox;if(!m(t,e))return o;for(var r,i,a,s,c=[];e;){for(r=0,i=e.children.length;r<i;r++)a=e.children[r],s=e.leaf?n(a):a,m(t,s)&&(e.leaf?o.push(a):p(t,s)?this._all(a,o):c.push(a));e=c.pop()}return o},collides:function(t){var e=this.data,o=this.toBBox;if(!m(t,e))return!1;for(var n,r,i,a,s=[];e;){for(n=0,r=e.children.length;n<r;n++)if(i=e.children[n],a=e.leaf?o(i):i,m(t,a)){if(e.leaf||p(t,a))return!0;s.push(i)}e=s.pop()}return!1},load:function(t){if(!t||!t.length)return this;if(t.length<this._minEntries){for(var e=0,o=t.length;e<o;e++)this.insert(t[e]);return this}var n=this._build(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===n.height)this._splitRoot(this.data,n);else{if(this.data.height<n.height){var r=this.data;this.data=n,n=r}this._insert(n,this.data.height-n.height-1,!0)}else this.data=n;return this},insert:function(t){return t&&this._insert(t,this.data.height-1),this},clear:function(){return this.data=d([]),this},remove:function(t,e){if(!t)return this;for(var o,r,i,a,s=this.data,c=this.toBBox(t),h=[],u=[];s||h.length;){if(s||(s=h.pop(),r=h[h.length-1],o=u.pop(),a=!0),s.leaf&&-1!==(i=n(t,s.children,e)))return s.children.splice(i,1),h.push(s),this._condense(h),this;a||s.leaf||!p(s,c)?r?(o++,s=r.children[o],a=!1):s=null:(h.push(s),u.push(o),o=0,r=s,s=s.children[0])}return this},toBBox:function(t){return t},compareMinX:s,compareMinY:c,toJSON:function(){return this.data},fromJSON:function(t){return this.data=t,this},_all:function(t,e){for(var o=[];t;)t.leaf?e.push.apply(e,t.children):o.push.apply(o,t.children),t=o.pop();return e},_build:function(t,e,o,n){var i,a=o-e+1,s=this._maxEntries;if(a<=s)return i=d(t.slice(e,o+1)),r(i,this.toBBox),i;n||(n=Math.ceil(Math.log(a)/Math.log(s)),s=Math.ceil(a/Math.pow(s,n-1))),i=d([]),i.leaf=!1,i.height=n;var c,h,u,l,f=Math.ceil(a/s),p=f*Math.ceil(Math.sqrt(s));for(y(t,e,o,p,this.compareMinX),c=e;c<=o;c+=p)for(u=Math.min(c+p-1,o),y(t,c,u,f,this.compareMinY),h=c;h<=u;h+=f)l=Math.min(h+f-1,u),i.children.push(this._build(t,h,l,n-1));return r(i,this.toBBox),i},_chooseSubtree:function(t,e,o,n){for(var r,i,a,s,c,u,f,p;;){if(n.push(e),e.leaf||n.length-1===o)break;for(f=p=1/0,r=0,i=e.children.length;r<i;r++)a=e.children[r],c=h(a),u=l(t,a)-c,u<p?(p=u,f=c<f?c:f,s=a):u===p&&c<f&&(f=c,s=a);e=s||e.children[0]}return e},_insert:function(t,e,o){var n=this.toBBox,r=o?t:n(t),i=[],s=this._chooseSubtree(r,this.data,e,i);for(s.children.push(t),a(s,r);e>=0&&i[e].children.length>this._maxEntries;)this._split(i,e),e--;this._adjustParentBBoxes(r,i,e)},_split:function(t,e){var o=t[e],n=o.children.length,i=this._minEntries;this._chooseSplitAxis(o,i,n);var a=this._chooseSplitIndex(o,i,n),s=d(o.children.splice(a,o.children.length-a));s.height=o.height,s.leaf=o.leaf,r(o,this.toBBox),r(s,this.toBBox),e?t[e-1].children.push(s):this._splitRoot(o,s)},_splitRoot:function(t,e){this.data=d([t,e]),this.data.height=t.height+1,this.data.leaf=!1,r(this.data,this.toBBox)},_chooseSplitIndex:function(t,e,o){var n,r,a,s,c,u,l,p;for(u=l=1/0,n=e;n<=o-e;n++)r=i(t,0,n,this.toBBox),a=i(t,n,o,this.toBBox),s=f(r,a),c=h(r)+h(a),s<u?(u=s,p=n,l=c<l?c:l):s===u&&c<l&&(l=c,p=n);return p},_chooseSplitAxis:function(t,e,o){var n=t.leaf?this.compareMinX:s,r=t.leaf?this.compareMinY:c;this._allDistMargin(t,e,o,n)<this._allDistMargin(t,e,o,r)&&t.children.sort(n)},_allDistMargin:function(t,e,o,n){t.children.sort(n);var r,s,c=this.toBBox,h=i(t,0,e,c),l=i(t,o-e,o,c),f=u(h)+u(l);for(r=e;r<o-e;r++)s=t.children[r],a(h,t.leaf?c(s):s),f+=u(h);for(r=o-e-1;r>=e;r--)s=t.children[r],a(l,t.leaf?c(s):s),f+=u(l);return f},_adjustParentBBoxes:function(t,e,o){for(var n=o;n>=0;n--)a(e[n],t)},_condense:function(t){for(var e,o=t.length-1;o>=0;o--)0===t[o].children.length?o>0?(e=t[o-1].children,e.splice(e.indexOf(t[o]),1)):this.clear():r(t[o],this.toBBox)},_initFormat:function(t){var e=["return a"," - b",";"];this.compareMinX=new Function("a","b",e.join(t[0])),this.compareMinY=new Function("a","b",e.join(t[1])),this.toBBox=new Function("a","return {minX: a"+t[0]+", minY: a"+t[1]+", maxX: a"+t[2]+", maxY: a"+t[3]+"};")}},q.default=D;var H=Object.freeze({coordEach:g,coordReduce:v,propEach:_,propReduce:x,featureEach:P,featureReduce:M,coordAll:b,geomEach:w,geomReduce:C,flattenEach:E,flattenReduce:G,segmentEach:k,segmentReduce:B,feature:L,lineString:X,lineEach:Y,lineReduce:S}),I=H&&void 0||H,V=q,W=I,U=W.featureEach,z=W.coordEach,Z=function(t){var e=V(t);return e.insert=function(t){if(Array.isArray(t)){var e=t;t=T(e),t.bbox=e}else t.bbox=t.bbox?t.bbox:O(t);return V.prototype.insert.call(this,t)},e.load=function(t){var e=[];return Array.isArray(t)?t.forEach(function(t){var o=T(t);o.bbox=t,e.push(o)}):U(t,function(t){t.bbox=t.bbox?t.bbox:O(t),e.push(t)}),V.prototype.load.call(this,e)},e.remove=function(t){if(Array.isArray(t)){var e=t;t=T(e),t.bbox=e}return V.prototype.remove.call(this,t)},e.clear=function(){return V.prototype.clear.call(this)},e.search=function(t){return{type:"FeatureCollection",features:V.prototype.search.call(this,this.toBBox(t))}},e.collides=function(t){return V.prototype.collides.call(this,this.toBBox(t))},e.all=function(){return{type:"FeatureCollection",features:V.prototype.all.call(this)}},e.toJSON=function(){return V.prototype.toJSON.call(this)},e.fromJSON=function(t){return V.prototype.fromJSON.call(this,t)},e.toBBox=function(t){var e;return e=t.bbox?t.bbox:Array.isArray(t)&&4===t.length?t:O(t),{minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]}},e},K={mode:"line",tolerance:10,symbol:{markerType:"ellipse",markerFill:"#0f89f5",markerLineColor:"#fff",markerLineWidth:2,markerLineOpacity:1,markerWidth:15,markerHeight:15}},Q=function(t){function o(e){A(this,o);var n=j(this,t.call(this,e));return n.tree=Z(),n}return R(o,t),o.prototype.getMode=function(){if(this._mode=this._mode?this._mode:this.options.mode,this._checkMode(this._mode))return this._mode;throw new Error("snap mode is invalid")},o.prototype.setMode=function(t){if(!this._checkMode(this._mode))throw new Error("snap mode is invalid");if(this._mode=t,this.snaplayer){var e=this.snaplayer.getGeometries();this.allGeometries=this._compositGeometries(e)}},o.prototype.addTo=function(t){var o=e.INTERNAL_LAYER_PREFIX+"_snapto";this._mousemoveLayer=new e.VectorLayer(o).addTo(t),this._map=t,this.allGeometries=[],this.enable()},o.prototype.remove=function(){this.disable(),this._mousemoveLayer&&(this._mousemoveLayer.remove(),delete this._mousemoveLayer)},o.prototype.getMap=function(){return this._map},o.prototype._checkMode=function(t){return"point"===t||"line"===t},o.prototype.enable=function(){var t=this.getMap();if(this.snaplayer){var e=this.snaplayer.getGeometries();this.allGeometries=this._compositGeometries(e)}if(!this.allGeometries)throw new Error("you should set geometries which are snapped to firstly!");this._mousemove||this._registerEvents(t),this._mousemoveLayer&&this._mousemoveLayer.show()},o.prototype.disable=function(){var t=this.getMap();t.off("mousemove touchstart",this._mousemove),t.off("mousedown",this._mousedown,this),t.off("mouseup",this._mouseup,this),this._mousemoveLayer&&this._mousemoveLayer.hide(),delete this._mousemove,this.allGeometries=[]},o.prototype.setGeometries=function(t){t=t instanceof Array?t:[t],this.allGeometries=this._compositGeometries(t)},o.prototype.setLayer=function(t){if(t instanceof e.VectorLayer){var o=t.getGeometries();this.snaplayer=t,this.allGeometries=this._compositGeometries(o),t.on("addgeo",function(){var t=this.snaplayer.getGeometries();this.allGeometries=this._compositGeometries(t)},this),this.snaplayer.on("clear",function(){this._clearGeometries()},this),this._mousemoveLayer.bringToFront()}},o.prototype.bindDrawTool=function(t){var o=this;t instanceof e.DrawTool&&(t.on("drawstart",function(t){o.snapPoint&&(o._resetCoordinates(t.target._geometry,o.snapPoint),o._resetClickPoint(t.target._clickCoords,o.snapPoint))},this),t.on("mousemove",function(t){if(o.snapPoint){var n=t.target.getMode(),r=t.target.getMap();if("circle"===n||"freeHandCircle"===n){var i=r.computeLength(t.target._geometry.getCenter(),o.snapPoint);t.target._geometry.setRadius(i)}else if("ellipse"===n||"freeHandEllipse"===n){var a=t.target._geometry.getCenter(),s=r.computeLength(a,new e.Coordinate({x:o.snapPoint.x,y:a.y})),c=r.computeLength(a,new e.Coordinate({x:a.x,y:o.snapPoint.y}));t.target._geometry.setWidth(2*s),t.target._geometry.setHeight(2*c)}else if("rectangle"===n||"freeHandRectangle"===n){var h=r.coordToContainerPoint(new e.Coordinate({x:o.snapPoint.x,y:o.snapPoint.y})),u=r.coordToContainerPoint(t.target._geometry.getFirstCoordinate()),l=[[u.x,u.y],[h.x,u.y],[h.x,h.y],[u.x,h.y]];t.target._geometry.setCoordinates(l.map(function(t){return r.containerPointToCoord(new e.Point(t))}))}else o._resetCoordinates(t.target._geometry,o.snapPoint)}},this),t.on("drawvertex",function(t){o.snapPoint&&(o._resetCoordinates(t.target._geometry,o.snapPoint),o._resetClickPoint(t.target._clickCoords,o.snapPoint))},this),t.on("drawend",function(t){if(o.snapPoint){var n=t.target.getMode(),r=t.target.getMap(),i=t.geometry;if("circle"===n||"freeHandCircle"===n){var a=r.computeLength(t.target._geometry.getCenter(),o.snapPoint);i.setRadius(a)}else if("ellipse"===n||"freeHandEllipse"===n){var s=i.getCenter(),c=r.computeLength(s,new e.Coordinate({x:o.snapPoint.x,y:s.y})),h=r.computeLength(s,new e.Coordinate({x:s.x,y:o.snapPoint.y}));i.setWidth(2*c),i.setHeight(2*h)}else if("rectangle"===n||"freeHandRectangle"===n){var u=r.coordToContainerPoint(new e.Coordinate({x:o.snapPoint.x,y:o.snapPoint.y})),l=r.coordToContainerPoint(i.getFirstCoordinate()),f=[[l.x,l.y],[u.x,l.y],[u.x,u.y],[l.x,u.y]];i.setCoordinates(f.map(function(t){return r.containerPointToCoord(new e.Point(t))}))}else o._resetCoordinates(i,o.snapPoint)}},this))},o.prototype._resetCoordinates=function(t,o){if(!t)return t;var n=t.getCoordinates();if(t instanceof e.Polygon){if(t instanceof e.Circle)return t;var r=n[0];r instanceof Array&&r.length>2&&(r[r.length-2].x=o.x,r[r.length-2].y=o.y)}else n instanceof Array?(n[n.length-1].x=o.x,n[n.length-1].y=o.y):n instanceof e.Coordinate&&(n.x=o.x,n.y=o.y);return t.setCoordinates(n),t},o.prototype._resetClickPoint=function(t,e){t&&(t[t.length-1].x=e.x,t[t.length-1].y=e.y)},o.prototype._addGeometries=function(t){t=t instanceof Array?t:[t];var e=this._compositGeometries(t);this.allGeometries=this.allGeometries.concat(e)},o.prototype._clearGeometries=function(){this.addGeometries=[]},o.prototype._prepareGeometries=function(t){if(this.allGeometries){var e=this.allGeometries;this.tree.clear(),this.tree.load({type:"FeatureCollection",features:e}),this.inspectExtent=this._createInspectExtent(t);return this.tree.search(this.inspectExtent)}return null},o.prototype._compositGeometries=function(t){var e=[],o=this.getMode();return"point"===o?e=this._compositToPoints(t):"line"===o&&(e=this._compositToLines(t)),e},o.prototype._compositToPoints=function(t){var e=[];return t.forEach(function(t){e=e.concat(this._parserToPoints(t))}.bind(this)),e},o.prototype._createMarkers=function(t){var o=[];return t.forEach(function(t){if(t instanceof Array)t.forEach(function(t){var n=new e.Marker(t,{properties:{}});n=n.toGeoJSON(),o.push(n)});else{var n=new e.Marker(t,{properties:{}});n=n.toGeoJSON(),o.push(n)}}),o},o.prototype._parserToPoints=function(t){var e=t.getType(),o=null;o="Circle"===e||"Ellipse"===e?t.getShell():t.getCoordinates();var n=[];if(o[0]instanceof Array)o.forEach(function(t){var e=this._createMarkers(t);n=n.concat(e)}.bind(this));else{o instanceof Array||(o=[o]);var r=this._createMarkers(o);n=n.concat(r)}return n},o.prototype._compositToLines=function(t){var e=[];return t.forEach(function(t){switch(t.getType()){case"Point":var o=t.toGeoJSON();o.properties={},e.push(o);break;case"LineString":case"Polygon":e=e.concat(this._parserGeometries(t,1))}}.bind(this)),e},o.prototype._parserGeometries=function(t,e){var o=t.getCoordinates(),n=[];if(o[0]instanceof Array)o.forEach(function(o){var r=this._createLine(o,e,t);n=n.concat(r)}.bind(this));else{var r=this._createLine(o,e,t);n=n.concat(r)}return n},o.prototype._createLine=function(t,o,n){for(var r=[],i=t.length-o,a=0;a<i;a++){var s=new e.LineString([t[a],t[a+1]],{properties:{obj:n}});r.push(s.toGeoJSON())}return r},o.prototype._createInspectExtent=function(t){var o=this.options.tolerance?this.options.tolerance:10,n=this.getMap(),r=n.getZoom(),i=n.coordinateToPoint(t,r),a=n.pointToCoordinate(new e.Point([i.x-o,i.y-o]),r),s=n.pointToCoordinate(new e.Point([i.x+o,i.y-o]),r),c=n.pointToCoordinate(new e.Point([i.x-o,i.y+o]),r),h=n.pointToCoordinate(new e.Point([i.x+o,i.y+o]),r);return{type:"Feature",properties:{},geometry:{type:"Polygon",coordinates:[[[a.x,a.y],[s.x,s.y],[h.x,h.y],[c.x,c.y]]]}}},o.prototype._registerEvents=function(t){this._needFindGeometry=!0,this._mousemove=function(t){if(this.mousePoint=t.coordinate,this._marker?this._marker.setCoordinates(t.coordinate):this._marker=new e.Marker(t.coordinate,{symbol:this.options.symbol}).addTo(this._mousemoveLayer),this._needFindGeometry){var o=this._findGeometry(t.coordinate);o.features.length>0?(this.snapPoint=this._getSnapPoint(o),this.snapPoint&&this._marker.setCoordinates([this.snapPoint.x,this.snapPoint.y])):this.snapPoint=null}},this._mousedown=function(){this._needFindGeometry=!1},this._mouseup=function(){this._needFindGeometry=!0},t.on("mousemove touchstart",this._mousemove,this),t.on("mousedown",this._mousedown,this),t.on("mouseup",this._mouseup,this)},o.prototype._setDistance=function(t){for(var e=[],o=0;o<t.length;o++){var n=t[o];if("LineString"===n.geometry.type){var r=this._distToPolyline(this.mousePoint,n);e.push({geoObject:n,distance:r})}else if("Point"===n.geometry.type){var i=this._distToPoint(this.mousePoint,n);e.push({geoObject:n,distance:i})}}return e},o.prototype._findNearestGeometries=function(t){var e=this._setDistance(t);return e=e.sort(this._compare(e,"distance")),e[0]},o.prototype._findGeometry=function(t){return this._prepareGeometries(t)},o.prototype._getSnapPoint=function(t){var e=this._findNearestGeometries(t.features),o=null;if(!this._validDistance(e.distance))return null;if("Point"===e.geoObject.geometry.type)o={x:e.geoObject.geometry.coordinates[0],y:e.geoObject.geometry.coordinates[1]};else if("LineString"===e.geoObject.geometry.type){var n=this._setEquation(e.geoObject);if(0===n.A)o={x:this.mousePoint.x,y:e.geoObject.geometry.coordinates[0][1]};else if(n.A===1/0)o={x:e.geoObject.geometry.coordinates[0][0],y:this.mousePoint.y};else{var r=n.B/n.A,i=this._setVertiEquation(r,this.mousePoint);o=this._solveEquation(n,i)}}return o},o.prototype._distToPolyline=function(t,e){var o=this._setEquation(e),n=o.A,r=o.B,i=o.C;return Math.abs((n*t.x+r*t.y+i)/Math.sqrt(Math.pow(n,2)+Math.pow(r,2)))},o.prototype._validDistance=function(t){return!(t/this.getMap().getResolution()>this.options.tolerance)},o.prototype._distToPoint=function(t,e){var o=[t.x,t.y],n=e.geometry.coordinates;return Math.sqrt(Math.pow(o[0]-n[0],2)+Math.pow(o[1]-n[1],2))},o.prototype._setEquation=function(t){var e=t.geometry.coordinates,o=e[0],n=e[1],r=Number((o[1]-n[1])/(o[0]-n[0]).toString());return{A:r,B:-1,C:o[1]-r*o[0]}},o.prototype._setVertiEquation=function(t,e){return{A:t,B:-1,C:e.y-t*e.x}},o.prototype._solveEquation=function(t,e){var o=t.A,n=t.B,r=t.C,i=e.A,a=e.B,s=e.C;return{x:(n*s-r*a)/(o*a-i*n),y:(o*s-i*r)/(n*i-a*o)}},o.prototype._compare=function(t,e){return function(t,o){var n=t[e],r=o[e];return r<n?1:r>n?-1:0}},o}(e.Class);Q.mergeOptions(K),t.SnapTool=Q,Object.defineProperty(t,"__esModule",{value:!0}),"undefined"!=typeof console&&console.log("maptalks.snapto v0.1.11, requires maptalks@^0.33.1.")});
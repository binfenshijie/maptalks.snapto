/*!
 * maptalks.snapto v0.1.11
 * LICENSE : MIT
 * (c) 2016-2018 maptalks.org
 */
/*!
 * requires maptalks@^0.33.1 
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("maptalks")):"function"==typeof define&&define.amd?define(["exports","maptalks"],t):t(e.maptalks=e.maptalks||{},e.maptalks)}(this,function(e,t){"use strict";function o(e,t){if(!(this instanceof o))return new o(e,t);this._maxEntries=Math.max(4,e||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),t&&this._initFormat(t),this.clear()}function r(e,t,o){if(!o)return t.indexOf(e);for(var r=0;r<t.length;r++)if(o(e,t[r]))return r;return-1}function i(e,t){n(e,0,e.children.length,t,e)}function n(e,t,o,r,i){i||(i=y(null)),i.minX=1/0,i.minY=1/0,i.maxX=-1/0,i.maxY=-1/0;for(var n,s=t;s<o;s++)n=e.children[s],a(i,e.leaf?r(n):n);return i}function a(e,t){return e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY),e}function s(e,t){return e.minX-t.minX}function c(e,t){return e.minY-t.minY}function h(e){return(e.maxX-e.minX)*(e.maxY-e.minY)}function l(e){return e.maxX-e.minX+(e.maxY-e.minY)}function u(e,t){return(Math.max(t.maxX,e.maxX)-Math.min(t.minX,e.minX))*(Math.max(t.maxY,e.maxY)-Math.min(t.minY,e.minY))}function f(e,t){var o=Math.max(e.minX,t.minX),r=Math.max(e.minY,t.minY),i=Math.min(e.maxX,t.maxX),n=Math.min(e.maxY,t.maxY);return Math.max(0,i-o)*Math.max(0,n-r)}function p(e,t){return e.minX<=t.minX&&e.minY<=t.minY&&t.maxX<=e.maxX&&t.maxY<=e.maxY}function m(e,t){return t.minX<=e.maxX&&t.minY<=e.maxY&&t.maxX>=e.minX&&t.maxY>=e.minY}function y(e){return{children:e,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function d(e,t,o,r,i){for(var n,a=[t,o];a.length;)o=a.pop(),t=a.pop(),o-t<=r||(n=t+Math.ceil((o-t)/r/2)*r,J(e,n,t,o,i),a.push(t,n,n,o))}function g(e,t,o){if(null!==e){var r,i,n,a,s,c,h,l,u,f,p=0,m=0,y=e.type,d="FeatureCollection"===y,v="Feature"===y,_=d?e.features.length:1;for(r=0;r<_;r++)for(u=d?e.features[r].geometry:v?e.geometry:e,f=!!u&&"GeometryCollection"===u.type,h=f?u.geometries.length:1,i=0;i<h;i++){var x=0;if(null!==(c=f?u.geometries[i]:u)){l=c.coordinates;var P=c.type;switch(p=!o||"Polygon"!==P&&"MultiPolygon"!==P?0:1,P){case null:break;case"Point":t(l,m,r,x),m++,x++;break;case"LineString":case"MultiPoint":for(n=0;n<l.length;n++)t(l[n],m,r,x),m++,"MultiPoint"===P&&x++;"LineString"===P&&x++;break;case"Polygon":case"MultiLineString":for(n=0;n<l.length;n++){for(a=0;a<l[n].length-p;a++)t(l[n][a],m,r,x),m++;"MultiLineString"===P&&x++}"Polygon"===P&&x++;break;case"MultiPolygon":for(n=0;n<l.length;n++){for(a=0;a<l[n].length;a++)for(s=0;s<l[n][a].length-p;s++)t(l[n][a][s],m,r,x),m++;x++}break;case"GeometryCollection":for(n=0;n<c.geometries.length;n++)g(c.geometries[n],t,o);break;default:throw new Error("Unknown Geometry Type")}}}}}function v(e,t,o,r){var i=o;return g(e,function(e,r,n,a){i=0===r&&void 0===o?e:t(i,e,r,n,a)},r),i}function _(e,t){var o;switch(e.type){case"FeatureCollection":for(o=0;o<e.features.length;o++)t(e.features[o].properties,o);break;case"Feature":t(e.properties,0)}}function x(e,t,o){var r=o;return _(e,function(e,i){r=0===i&&void 0===o?e:t(r,e,i)}),r}function P(e,t){if("Feature"===e.type)t(e,0);else if("FeatureCollection"===e.type)for(var o=0;o<e.features.length;o++)t(e.features[o],o)}function b(e,t,o){var r=o;return P(e,function(e,i){r=0===i&&void 0===o?e:t(r,e,i)}),r}function M(e){var t=[];return g(e,function(e){t.push(e)}),t}function w(e,t){var o,r,i,n,a,s,c,h,l=0,u="FeatureCollection"===e.type,f="Feature"===e.type,p=u?e.features.length:1;for(o=0;o<p;o++){for(s=u?e.features[o].geometry:f?e.geometry:e,h=u?e.features[o].properties:f?e.properties:{},c=!!s&&"GeometryCollection"===s.type,a=c?s.geometries.length:1,i=0;i<a;i++)if(null!==(n=c?s.geometries[i]:s))switch(n.type){case"Point":case"LineString":case"MultiPoint":case"Polygon":case"MultiLineString":case"MultiPolygon":t(n,l,h);break;case"GeometryCollection":for(r=0;r<n.geometries.length;r++)t(n.geometries[r],l,h);break;default:throw new Error("Unknown Geometry Type")}else t(null,l,h);l++}}function G(e,t,o){var r=o;return w(e,function(e,i,n){r=0===i&&void 0===o?e:t(r,e,i,n)}),r}function C(e,t){w(e,function(e,o,r){var i=null===e?null:e.type;switch(i){case null:case"Point":case"LineString":case"Polygon":return void t(B(e,r),o,0)}var n;switch(i){case"MultiPoint":n="Point";break;case"MultiLineString":n="LineString";break;case"MultiPolygon":n="Polygon"}e.coordinates.forEach(function(e,i){t(B({type:n,coordinates:e},r),o,i)})})}function E(e,t,o){var r=o;return C(e,function(e,i,n){r=0===i&&0===n&&void 0===o?e:t(r,e,i,n)}),r}function L(e,t){C(e,function(e,o,r){var i=0;if(e.geometry){var n=e.geometry.type;"Point"!==n&&"MultiPoint"!==n&&v(e,function(n,a){var s=X([n,a],e.properties);return t(s,o,r,i),i++,a})}})}function k(e,t,o){var r=o,i=!1;return L(e,function(e,n,a,s){r=!1===i&&void 0===o?e:t(r,e,n,a,s),i=!0}),r}function B(e,t){if(void 0===e)throw new Error("No geometry passed");return{type:"Feature",properties:t||{},geometry:e}}function X(e,t){if(!e)throw new Error("No coordinates passed");if(e.length<2)throw new Error("Coordinates must be an array of two or more positions");return{type:"Feature",properties:t||{},geometry:{type:"LineString",coordinates:e}}}function Y(e,t){if(!e)throw new Error("geojson is required");var o=e.geometry?e.geometry.type:e.type;if(!o)throw new Error("invalid geojson");if("FeatureCollection"===o)throw new Error("FeatureCollection is not supported");if("GeometryCollection"===o)throw new Error("GeometryCollection is not supported");var r=e.geometry?e.geometry.coordinates:e.coordinates;if(!r)throw new Error("geojson must contain coordinates");switch(o){case"LineString":return void t(r,0,0);case"Polygon":case"MultiLineString":for(var i=0,n=0;n<r.length;n++)"MultiLineString"===o&&(i=n),t(r[n],n,i);return;case"MultiPolygon":for(var a=0;a<r.length;a++)for(var s=0;s<r[a].length;s++)t(r[a][s],s,a);return;default:throw new Error(o+" geometry not supported")}}function S(e,t,o){var r=o;return Y(e,function(e,i,n){r=0===i&&void 0===o?e:t(r,e,i,n)}),r}function T(e){var t=[e[0],e[1]],o=[e[0],e[3]],r=[e[2],e[3]];return{type:"Feature",bbox:e,properties:{},geometry:{type:"Polygon",coordinates:[[t,[e[2],e[1]],r,o,t]]}}}function O(e){var t=[1/0,1/0,-1/0,-1/0];return z(e,function(e){t[0]>e[0]&&(t[0]=e[0]),t[1]>e[1]&&(t[1]=e[1]),t[2]<e[0]&&(t[2]=e[0]),t[3]<e[1]&&(t[3]=e[1])}),t}function A(e,t){for(var o=Object.getOwnPropertyNames(t),r=0;r<o.length;r++){var i=o[r],n=Object.getOwnPropertyDescriptor(t,i);n&&n.configurable&&void 0===e[i]&&Object.defineProperty(e,i,n)}return e}function F(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function j(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function R(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):A(e,t))}var N=("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self,function(e,t){return t={exports:{}},e(t,t.exports),t.exports}(function(e,t){!function(t,o){e.exports=function(){function e(e,o,i,n,a){t(e,o,i||0,n||e.length-1,a||r)}function t(e,r,i,n,a){for(;n>i;){if(n-i>600){var s=n-i+1,c=r-i+1,h=Math.log(s),l=.5*Math.exp(2*h/3),u=.5*Math.sqrt(h*l*(s-l)/s)*(c-s/2<0?-1:1);t(e,r,Math.max(i,Math.floor(r-c*l/s+u)),Math.min(n,Math.floor(r+(s-c)*l/s+u)),a)}var f=e[r],p=i,m=n;for(o(e,i,r),a(e[n],f)>0&&o(e,i,n);p<m;){for(o(e,p,m),p++,m--;a(e[p],f)<0;)p++;for(;a(e[m],f)>0;)m--}0===a(e[i],f)?o(e,i,m):(m++,o(e,m,n)),m<=r&&(i=m+1),r<=m&&(n=m-1)}}function o(e,t,o){var r=e[t];e[t]=e[o],e[o]=r}function r(e,t){return e<t?-1:e>t?1:0}return e}()}()})),q=o,D=o,J=N;o.prototype={all:function(){return this._all(this.data,[])},search:function(e){var t=this.data,o=[],r=this.toBBox;if(!m(e,t))return o;for(var i,n,a,s,c=[];t;){for(i=0,n=t.children.length;i<n;i++)a=t.children[i],s=t.leaf?r(a):a,m(e,s)&&(t.leaf?o.push(a):p(e,s)?this._all(a,o):c.push(a));t=c.pop()}return o},collides:function(e){var t=this.data,o=this.toBBox;if(!m(e,t))return!1;for(var r,i,n,a,s=[];t;){for(r=0,i=t.children.length;r<i;r++)if(n=t.children[r],a=t.leaf?o(n):n,m(e,a)){if(t.leaf||p(e,a))return!0;s.push(n)}t=s.pop()}return!1},load:function(e){if(!e||!e.length)return this;if(e.length<this._minEntries){for(var t=0,o=e.length;t<o;t++)this.insert(e[t]);return this}var r=this._build(e.slice(),0,e.length-1,0);if(this.data.children.length)if(this.data.height===r.height)this._splitRoot(this.data,r);else{if(this.data.height<r.height){var i=this.data;this.data=r,r=i}this._insert(r,this.data.height-r.height-1,!0)}else this.data=r;return this},insert:function(e){return e&&this._insert(e,this.data.height-1),this},clear:function(){return this.data=y([]),this},remove:function(e,t){if(!e)return this;for(var o,i,n,a,s=this.data,c=this.toBBox(e),h=[],l=[];s||h.length;){if(s||(s=h.pop(),i=h[h.length-1],o=l.pop(),a=!0),s.leaf&&-1!==(n=r(e,s.children,t)))return s.children.splice(n,1),h.push(s),this._condense(h),this;a||s.leaf||!p(s,c)?i?(o++,s=i.children[o],a=!1):s=null:(h.push(s),l.push(o),o=0,i=s,s=s.children[0])}return this},toBBox:function(e){return e},compareMinX:s,compareMinY:c,toJSON:function(){return this.data},fromJSON:function(e){return this.data=e,this},_all:function(e,t){for(var o=[];e;)e.leaf?t.push.apply(t,e.children):o.push.apply(o,e.children),e=o.pop();return t},_build:function(e,t,o,r){var n,a=o-t+1,s=this._maxEntries;if(a<=s)return n=y(e.slice(t,o+1)),i(n,this.toBBox),n;r||(r=Math.ceil(Math.log(a)/Math.log(s)),s=Math.ceil(a/Math.pow(s,r-1))),n=y([]),n.leaf=!1,n.height=r;var c,h,l,u,f=Math.ceil(a/s),p=f*Math.ceil(Math.sqrt(s));for(d(e,t,o,p,this.compareMinX),c=t;c<=o;c+=p)for(l=Math.min(c+p-1,o),d(e,c,l,f,this.compareMinY),h=c;h<=l;h+=f)u=Math.min(h+f-1,l),n.children.push(this._build(e,h,u,r-1));return i(n,this.toBBox),n},_chooseSubtree:function(e,t,o,r){for(var i,n,a,s,c,l,f,p;;){if(r.push(t),t.leaf||r.length-1===o)break;for(f=p=1/0,i=0,n=t.children.length;i<n;i++)a=t.children[i],c=h(a),l=u(e,a)-c,l<p?(p=l,f=c<f?c:f,s=a):l===p&&c<f&&(f=c,s=a);t=s||t.children[0]}return t},_insert:function(e,t,o){var r=this.toBBox,i=o?e:r(e),n=[],s=this._chooseSubtree(i,this.data,t,n);for(s.children.push(e),a(s,i);t>=0&&n[t].children.length>this._maxEntries;)this._split(n,t),t--;this._adjustParentBBoxes(i,n,t)},_split:function(e,t){var o=e[t],r=o.children.length,n=this._minEntries;this._chooseSplitAxis(o,n,r);var a=this._chooseSplitIndex(o,n,r),s=y(o.children.splice(a,o.children.length-a));s.height=o.height,s.leaf=o.leaf,i(o,this.toBBox),i(s,this.toBBox),t?e[t-1].children.push(s):this._splitRoot(o,s)},_splitRoot:function(e,t){this.data=y([e,t]),this.data.height=e.height+1,this.data.leaf=!1,i(this.data,this.toBBox)},_chooseSplitIndex:function(e,t,o){var r,i,a,s,c,l,u,p;for(l=u=1/0,r=t;r<=o-t;r++)i=n(e,0,r,this.toBBox),a=n(e,r,o,this.toBBox),s=f(i,a),c=h(i)+h(a),s<l?(l=s,p=r,u=c<u?c:u):s===l&&c<u&&(u=c,p=r);return p},_chooseSplitAxis:function(e,t,o){var r=e.leaf?this.compareMinX:s,i=e.leaf?this.compareMinY:c;this._allDistMargin(e,t,o,r)<this._allDistMargin(e,t,o,i)&&e.children.sort(r)},_allDistMargin:function(e,t,o,r){e.children.sort(r);var i,s,c=this.toBBox,h=n(e,0,t,c),u=n(e,o-t,o,c),f=l(h)+l(u);for(i=t;i<o-t;i++)s=e.children[i],a(h,e.leaf?c(s):s),f+=l(h);for(i=o-t-1;i>=t;i--)s=e.children[i],a(u,e.leaf?c(s):s),f+=l(u);return f},_adjustParentBBoxes:function(e,t,o){for(var r=o;r>=0;r--)a(t[r],e)},_condense:function(e){for(var t,o=e.length-1;o>=0;o--)0===e[o].children.length?o>0?(t=e[o-1].children,t.splice(t.indexOf(e[o]),1)):this.clear():i(e[o],this.toBBox)},_initFormat:function(e){var t=["return a"," - b",";"];this.compareMinX=new Function("a","b",t.join(e[0])),this.compareMinY=new Function("a","b",t.join(e[1])),this.toBBox=new Function("a","return {minX: a"+e[0]+", minY: a"+e[1]+", maxX: a"+e[2]+", maxY: a"+e[3]+"};")}},q.default=D;var H=Object.freeze({coordEach:g,coordReduce:v,propEach:_,propReduce:x,featureEach:P,featureReduce:b,coordAll:M,geomEach:w,geomReduce:G,flattenEach:C,flattenReduce:E,segmentEach:L,segmentReduce:k,feature:B,lineString:X,lineEach:Y,lineReduce:S}),I=H&&void 0||H,V=q,W=I,U=W.featureEach,z=W.coordEach,Z=function(e){var t=V(e);return t.insert=function(e){if(Array.isArray(e)){var t=e;e=T(t),e.bbox=t}else e.bbox=e.bbox?e.bbox:O(e);return V.prototype.insert.call(this,e)},t.load=function(e){var t=[];return Array.isArray(e)?e.forEach(function(e){var o=T(e);o.bbox=e,t.push(o)}):U(e,function(e){e.bbox=e.bbox?e.bbox:O(e),t.push(e)}),V.prototype.load.call(this,t)},t.remove=function(e){if(Array.isArray(e)){var t=e;e=T(t),e.bbox=t}return V.prototype.remove.call(this,e)},t.clear=function(){return V.prototype.clear.call(this)},t.search=function(e){return{type:"FeatureCollection",features:V.prototype.search.call(this,this.toBBox(e))}},t.collides=function(e){return V.prototype.collides.call(this,this.toBBox(e))},t.all=function(){return{type:"FeatureCollection",features:V.prototype.all.call(this)}},t.toJSON=function(){return V.prototype.toJSON.call(this)},t.fromJSON=function(e){return V.prototype.fromJSON.call(this,e)},t.toBBox=function(e){var t;return t=e.bbox?e.bbox:Array.isArray(e)&&4===e.length?e:O(e),{minX:t[0],minY:t[1],maxX:t[2],maxY:t[3]}},t},K={mode:"line",tolerance:10,symbol:{markerType:"ellipse",markerFill:"#0f89f5",markerLineColor:"#fff",markerLineWidth:2,markerLineOpacity:1,markerWidth:15,markerHeight:15}},Q=function(e){function o(t){F(this,o);var r=j(this,e.call(this,t));return r.tree=Z(),r}return R(o,e),o.prototype.getMode=function(){if(this._mode=this._mode?this._mode:this.options.mode,this._checkMode(this._mode))return this._mode;throw new Error("snap mode is invalid")},o.prototype.setMode=function(e){if(!this._checkMode(this._mode))throw new Error("snap mode is invalid");if(this._mode=e,this.snaplayer)if(this.snaplayer instanceof Array){var t;this.allLayersGeometries=[],this.snaplayer.forEach(function(e,t){var o=e.getGeometries();this.allLayersGeometries[t]=this._compositGeometries(o)}.bind(this)),this.allGeometries=(t=[]).concat.apply(t,this.allLayersGeometries)}else{var o=this.snaplayer.getGeometries();this.allGeometries=this._compositGeometries(o)}},o.prototype.addTo=function(e){var o=t.INTERNAL_LAYER_PREFIX+"_snapto";this._mousemoveLayer=new t.VectorLayer(o).addTo(e),this._map=e,this.allGeometries=[],this.enable()},o.prototype.remove=function(){this.disable(),this._mousemoveLayer&&(this._mousemoveLayer.remove(),delete this._mousemoveLayer)},o.prototype.getMap=function(){return this._map},o.prototype._checkMode=function(e){return"point"===e||"line"===e},o.prototype.enable=function(){var e=this.getMap();if(this.snaplayer)if(this.snaplayer instanceof Array){var t;this.allLayersGeometries=[],this.snaplayer.forEach(function(e,t){var o=e.getGeometries();this.allLayersGeometries[t]=this._compositGeometries(o)}.bind(this)),this.allGeometries=(t=[]).concat.apply(t,this.allLayersGeometries)}else{var o=this.snaplayer.getGeometries();this.allGeometries=this._compositGeometries(o)}if(!this.allGeometries)throw new Error("you should set geometries which are snapped to firstly!");this._mousemove||this._registerEvents(e),this._mousemoveLayer&&this._mousemoveLayer.show()},o.prototype.disable=function(){var e=this.getMap();e.off("mousemove touchstart",this._mousemove),e.off("mousedown",this._mousedown,this),e.off("mouseup",this._mouseup,this),this._mousemoveLayer&&this._mousemoveLayer.hide(),delete this._mousemove,this.allGeometries=[]},o.prototype.setGeometries=function(e){e=e instanceof Array?e:[e],this.allGeometries=this._compositGeometries(e)},o.prototype.setLayer=function(e){if(e instanceof Array){var o;this.snaplayer=[],this.allLayersGeometries=[],e.forEach(function(e,o){if(e instanceof t.VectorLayer){this.snaplayer.push(e);var r=e.getGeometries();this.allLayersGeometries[o]=this._compositGeometries(r),e.on("addgeo",function(){var e,t=this.snaplayer[o].getGeometries();this.allLayersGeometries[o]=this._compositGeometries(t),this.allGeometries=(e=[]).concat.apply(e,this.allLayersGeometries)},this),e.on("clear",function(){var e;this.allLayersGeometries.splice(o,1),this.allGeometries=(e=[]).concat.apply(e,this.allLayersGeometries)},this)}}.bind(this)),this.allGeometries=(o=[]).concat.apply(o,this.allLayersGeometries),this._mousemoveLayer.bringToFront()}else if(e instanceof t.VectorLayer){var r=e.getGeometries();this.snaplayer=e,this.allGeometries=this._compositGeometries(r),e.on("addgeo",function(){var e=this.snaplayer.getGeometries();this.allGeometries=this._compositGeometries(e)},this),this.snaplayer.on("clear",function(){this._clearGeometries()},this),this._mousemoveLayer.bringToFront()}},o.prototype.bindDrawTool=function(e){var o=this;e instanceof t.DrawTool&&(e.on("drawstart",function(e){o.snapPoint&&(o._resetCoordinates(e.target._geometry,o.snapPoint),o._resetClickPoint(e.target._clickCoords,o.snapPoint))},this),e.on("mousemove",function(e){if(o.snapPoint){var r=e.target.getMode(),i=e.target.getMap();if("circle"===r||"freeHandCircle"===r){var n=i.computeLength(e.target._geometry.getCenter(),o.snapPoint);e.target._geometry.setRadius(n)}else if("ellipse"===r||"freeHandEllipse"===r){var a=e.target._geometry.getCenter(),s=i.computeLength(a,new t.Coordinate({x:o.snapPoint.x,y:a.y})),c=i.computeLength(a,new t.Coordinate({x:a.x,y:o.snapPoint.y}));e.target._geometry.setWidth(2*s),e.target._geometry.setHeight(2*c)}else if("rectangle"===r||"freeHandRectangle"===r){var h=i.coordToContainerPoint(new t.Coordinate({x:o.snapPoint.x,y:o.snapPoint.y})),l=i.coordToContainerPoint(e.target._geometry.getFirstCoordinate()),u=[[l.x,l.y],[h.x,l.y],[h.x,h.y],[l.x,h.y]];e.target._geometry.setCoordinates(u.map(function(e){return i.containerPointToCoord(new t.Point(e))}))}else o._resetCoordinates(e.target._geometry,o.snapPoint)}},this),e.on("drawvertex",function(e){o.snapPoint&&(o._resetCoordinates(e.target._geometry,o.snapPoint),o._resetClickPoint(e.target._clickCoords,o.snapPoint))},this),e.on("drawend",function(e){if(o.snapPoint){var r=e.target.getMode(),i=e.target.getMap(),n=e.geometry;if("circle"===r||"freeHandCircle"===r){var a=i.computeLength(e.target._geometry.getCenter(),o.snapPoint);n.setRadius(a)}else if("ellipse"===r||"freeHandEllipse"===r){var s=n.getCenter(),c=i.computeLength(s,new t.Coordinate({x:o.snapPoint.x,y:s.y})),h=i.computeLength(s,new t.Coordinate({x:s.x,y:o.snapPoint.y}));n.setWidth(2*c),n.setHeight(2*h)}else if("rectangle"===r||"freeHandRectangle"===r){var l=i.coordToContainerPoint(new t.Coordinate({x:o.snapPoint.x,y:o.snapPoint.y})),u=i.coordToContainerPoint(n.getFirstCoordinate()),f=[[u.x,u.y],[l.x,u.y],[l.x,l.y],[u.x,l.y]];n.setCoordinates(f.map(function(e){return i.containerPointToCoord(new t.Point(e))}))}else o._resetCoordinates(n,o.snapPoint)}},this))},o.prototype._resetCoordinates=function(e,o){if(!e)return e;var r=e.getCoordinates();if(e instanceof t.Polygon){if(e instanceof t.Circle)return e;var i=r[0];i instanceof Array&&i.length>2&&(i[i.length-2].x=o.x,i[i.length-2].y=o.y)}else r instanceof Array?(r[r.length-1].x=o.x,r[r.length-1].y=o.y):r instanceof t.Coordinate&&(r.x=o.x,r.y=o.y);return e.setCoordinates(r),e},o.prototype._resetClickPoint=function(e,t){e&&(e[e.length-1].x=t.x,e[e.length-1].y=t.y)},o.prototype._addGeometries=function(e){e=e instanceof Array?e:[e];var t=this._compositGeometries(e);this.allGeometries=this.allGeometries.concat(t)},o.prototype._clearGeometries=function(){this.addGeometries=[]},o.prototype._prepareGeometries=function(e){if(this.allGeometries){var t=this.allGeometries;this.tree.clear(),this.tree.load({type:"FeatureCollection",features:t}),this.inspectExtent=this._createInspectExtent(e);return this.tree.search(this.inspectExtent)}return null},o.prototype._compositGeometries=function(e){var t=[],o=this.getMode();return"point"===o?t=this._compositToPoints(e):"line"===o&&(t=this._compositToLines(e)),t},o.prototype._compositToPoints=function(e){var t=[];return e.forEach(function(e){t=t.concat(this._parserToPoints(e))}.bind(this)),t},o.prototype._createMarkers=function(e){var o=[];return e.forEach(function(e){if(e instanceof Array)e.forEach(function(e){var r=new t.Marker(e,{properties:{}});r=r.toGeoJSON(),o.push(r)});else{var r=new t.Marker(e,{properties:{}});r=r.toGeoJSON(),o.push(r)}}),o},o.prototype._parserToPoints=function(e){var t=e.getType(),o=null;o="Circle"===t||"Ellipse"===t?e.getShell():e.getCoordinates();var r=[];if(o[0]instanceof Array)o.forEach(function(e){var t=this._createMarkers(e);r=r.concat(t)}.bind(this));else{o instanceof Array||(o=[o]);var i=this._createMarkers(o);r=r.concat(i)}return r},o.prototype._compositToLines=function(e){var t=[];return e.forEach(function(e){switch(e.getType()){case"Point":var o=e.toGeoJSON();o.properties={},t.push(o);break;case"LineString":case"Polygon":t=t.concat(this._parserGeometries(e,1))}}.bind(this)),t},o.prototype._parserGeometries=function(e,t){var o=e.getCoordinates(),r=[];if(o[0]instanceof Array)o.forEach(function(o){var i=this._createLine(o,t,e);r=r.concat(i)}.bind(this));else{var i=this._createLine(o,t,e);r=r.concat(i)}return r},o.prototype._createLine=function(e,o,r){for(var i=[],n=e.length-o,a=0;a<n;a++){var s=new t.LineString([e[a],e[a+1]],{properties:{obj:r}});i.push(s.toGeoJSON())}return i},o.prototype._createInspectExtent=function(e){var o=this.options.tolerance?this.options.tolerance:10,r=this.getMap(),i=r.getZoom(),n=r.coordinateToPoint(e,i),a=r.pointToCoordinate(new t.Point([n.x-o,n.y-o]),i),s=r.pointToCoordinate(new t.Point([n.x+o,n.y-o]),i),c=r.pointToCoordinate(new t.Point([n.x-o,n.y+o]),i),h=r.pointToCoordinate(new t.Point([n.x+o,n.y+o]),i);return{type:"Feature",properties:{},geometry:{type:"Polygon",coordinates:[[[a.x,a.y],[s.x,s.y],[h.x,h.y],[c.x,c.y]]]}}},o.prototype._registerEvents=function(e){this._needFindGeometry=!0,this._mousemove=function(e){if(this.mousePoint=e.coordinate,this._marker?this._marker.setCoordinates(e.coordinate):this._marker=new t.Marker(e.coordinate,{symbol:this.options.symbol}).addTo(this._mousemoveLayer),this._needFindGeometry){var o=this._findGeometry(e.coordinate);o.features.length>0?(this.snapPoint=this._getSnapPoint(o),this.snapPoint&&this._marker.setCoordinates([this.snapPoint.x,this.snapPoint.y])):this.snapPoint=null}},this._mousedown=function(){this._needFindGeometry=!1},this._mouseup=function(){this._needFindGeometry=!0},e.on("mousemove touchstart",this._mousemove,this),e.on("mousedown",this._mousedown,this),e.on("mouseup",this._mouseup,this)},o.prototype._setDistance=function(e){for(var t=[],o=0;o<e.length;o++){var r=e[o];if("LineString"===r.geometry.type){var i=this._distToPolyline(this.mousePoint,r);t.push({geoObject:r,distance:i})}else if("Point"===r.geometry.type){var n=this._distToPoint(this.mousePoint,r);t.push({geoObject:r,distance:n})}}return t},o.prototype._findNearestGeometries=function(e){var t=this._setDistance(e);return t=t.sort(this._compare(t,"distance")),t[0]},o.prototype._findGeometry=function(e){return this._prepareGeometries(e)},o.prototype._getSnapPoint=function(e){var t=this._findNearestGeometries(e.features),o=null;if(!this._validDistance(t.distance))return null;if("Point"===t.geoObject.geometry.type)o={x:t.geoObject.geometry.coordinates[0],y:t.geoObject.geometry.coordinates[1]};else if("LineString"===t.geoObject.geometry.type){var r=this._setEquation(t.geoObject);if(0===r.A)o={x:this.mousePoint.x,y:t.geoObject.geometry.coordinates[0][1]};else if(r.A===1/0)o={x:t.geoObject.geometry.coordinates[0][0],y:this.mousePoint.y};else{var i=r.B/r.A,n=this._setVertiEquation(i,this.mousePoint);o=this._solveEquation(r,n)}}return o},o.prototype._distToPolyline=function(e,t){var o=this._setEquation(t),r=o.A,i=o.B,n=o.C;return Math.abs((r*e.x+i*e.y+n)/Math.sqrt(Math.pow(r,2)+Math.pow(i,2)))},o.prototype._validDistance=function(e){return!(e/this.getMap().getResolution()>this.options.tolerance)},o.prototype._distToPoint=function(e,t){var o=[e.x,e.y],r=t.geometry.coordinates;return Math.sqrt(Math.pow(o[0]-r[0],2)+Math.pow(o[1]-r[1],2))},o.prototype._setEquation=function(e){var t=e.geometry.coordinates,o=t[0],r=t[1],i=Number((o[1]-r[1])/(o[0]-r[0]).toString());return{A:i,B:-1,C:o[1]-i*o[0]}},o.prototype._setVertiEquation=function(e,t){return{A:e,B:-1,C:t.y-e*t.x}},o.prototype._solveEquation=function(e,t){var o=e.A,r=e.B,i=e.C,n=t.A,a=t.B,s=t.C;return{x:(r*s-i*a)/(o*a-n*r),y:(o*s-n*i)/(r*n-a*o)}},o.prototype._compare=function(e,t){return function(e,o){var r=e[t],i=o[t];return i<r?1:i>r?-1:0}},o}(t.Class);Q.mergeOptions(K),e.SnapTool=Q,Object.defineProperty(e,"__esModule",{value:!0}),"undefined"!=typeof console&&console.log("maptalks.snapto v0.1.11, requires maptalks@^0.33.1.")});